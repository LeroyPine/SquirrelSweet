https://bigdata.51cto.com/art/202009/625181.htm

### Zookeeper 是什么？ 有哪些功能？

- ZooKeeper是一个 分布式的,开放源码的分布式应用程序协调服务。提供的功能有：配置维护,域名服务,分布式同步,组服务等 ,目标就是封装好复杂易出错的关键服务,将简单易用的接口和性能高效、功能稳定的系统提供给用户。
- 集群管理：监控节点的存活状态,运行请求等
- 主节点选举：主节点挂掉了之后可以从备用的节点开始新一轮选主,主节点选举说的就是这个选举的过程,使用Zookeeper可以协助完成这个过程。
- 分布式服务注册与订阅：
  - 在分布式环境下,同一个应用的服务会部署多份，并且所部署的服务具有相同的数据。 zk的一致性其实就保证了服务之间具有相同的数据。然后消费者可以去订阅这些服务,
  从而选取一个服务进行调用。
- 分布式锁:Zookeeper提供两种锁,独占锁,共享锁,独占锁即一次只有一个线程使用资源,共享锁是读锁共享,读写互斥。
- 命名服务:在分布式系统中,通过命名服务,客户端应用能够根据指定名字来获取资源或服务的地址,提供者等信息,因为zk的节点的结构是树形结构,然后保证了全局唯一的节点名称。

### Zookeeper 的集群架构是怎么样的？ （主从架构）

Zk是由多个服务组成的集群,一个leader节点,多个follower节点, leader提供读写服务,follower只能提供读服务。

### Zookeeper 是如何保证顺序一致性的？

顺序一致性主要是针对写请求。客户端发来一个请求之后会到达leader节点或者从节点,如果是从节点要将请求转到leader节点,
leader节点会为每一个请求分配一个 zxid,然后转发给从节点,
leader节点在收到写请求后,在广播事务的时候会分配一个全局递增的zxid。在进行广播, leader服务器会为每个follower节点分配一个单独的队列,
然后将需要广播的事务依次放入这些队列中,然后根据先进先出的策略进行发送。
每个follower节点在收到后会将其以事务日志的形式存入磁盘,并且在成功写入后返回给leader服务器一个ack响应。
如果有过半的从节点进行了响应,那么leader会广播一个commit的消息给所有follower,follower接收到请求后完成对事务的广播操作。


### Zookeeper 是强一致性的吗？
- 一致性指的是修改了一个副本节点后,其他副本节点也会进行同步修改,能够在其他副本节点读到修改后的值。
- 强一致性指的是修改了某个副本节点后,其他节点能够立刻读取到其他节点的值。
- Zookeeper其实不是强一致性的,Zk采用Zab协议,只要服务过半写入成功,数据就算写入成功了,如果请求落入到未同步完的节点上,那么读取到的数据还是旧的值。
- 所以读的数据就不是强一致性的,因此zk无法保证数据的强一致性。只能保证最终一致性,而且可以保证统一客户端的顺序一致性。


### 谈下你对ZAB协议的了解？

- ZAB协议就是Zk的原子广播协议。 分为两种::一是崩溃恢复,二是消息广播。
- 崩溃恢复的情况下有两种：
  - 一是集群刚启动的时候进行崩溃恢复。
  - 二是运行时服务异常进行崩溃恢复。
- 崩溃恢复: 集群中的节点进入一个选取leader的状态。开始进行投票,投票的时候每个节点会发送自己的zxid和服务器ID进行比较,其实就是选出zxid比较大的那个服务器节点。然后判断是否有过半的机器投票选出leader,如果有那么此节点就当选leader，否则就接着进行投票。选取出leader后,其他节点就变为follower节点,然后follower节点向服务器发出自己服务器最大的zxid,leader服务器收到后会与自己本地的提议缓存队列进行比较,判断使用哪种策略进行同步。然后就正常进行到消息广播。
- 消息广播: leader节点在收到写请求后,在广播事务的时候会分配一个全局递增的zxid。在进行广播, leader服务器会为每个follower节点分配一个单独的队列,然后将需要广播的事务依次放入这些队列中,然后根据先进先出的策略进行发送。每个follower节点在收到后会将其以事务日志的形式存入磁盘,并且在成功写入后返回给leader服务器一个ack响应。如果有过半的从节点进行了响应,那么leader会广播一个commit的消息给所有follower,follower接收到请求后完成对事务的广播操作。

### Zookeeper怎么保证主从节点的状态同步？

- Zookeeper的核心是原子广播机制, ZAB协议。
- 恢复模式：当服务启动或者领导这崩溃后,Zab就进入了恢复模式,当领导者被选举出来,其大多数完成了和leader的状态同步,那么恢复模式就结束了
- 广播模式：leader与多数follower进行了状态同步之后,他就可以进行广播消息了。

### Zookeeper部署模式？

- 单机部署
- 集群部署
- 伪集群部署

### 说一下Zk的通知机制？

- client端会对某个zNode建立一个watcher事件,当znode发生变化时，这些client会收到zk的通知,然后client可以根据znode变化做出业务上的改变。

### 集群中为什么要有主节点？

- 在分布式环境下,有些业务逻辑只需要及群众的某一台机器进行执行,其他的机器可以共享这个结果,这样可以大大减少重复计算,提高性能,于是 就需要 进行leader选举。

### 集群中有3台服务器,其中有一个宕机,这个时候zk还可以使用吗？

- 可以继续使用,单数服务器只要没超过一般的服务器宕机就可以继续使用 2n+1 n>0 最少3台 集群模式下

### 说一下两阶段提交和三阶段提交的过程?分别有什么问题？

- 两阶段：
    - 投票：
    - 提交执行:

### Zookeeper宕机如何处理？

- zk 集群的机制只要是超过半数的节点正常就可以提供服务。
- ZNode:
    - 持久节点： 持久节点,除非手动删除,否则zk节点一直存在于Zk上
    - 临时节点： 临时节点,临时节点的生命周期与客户端会话绑定,客户端失效,节点会被自动清理。  临时节点只能作为叶子节点。
    - 持久顺序节点：基本相同，增加了一个顺序属性。 由于父节点维护一个自增整型数字。
    - 临时顺序节点：临时顺序节点,在临时节点的基础添加了顺序特性。

### Zookeeper和Dubbo的关系？

- Dubbo的将注册中心进行抽象,使得他可以外接不同的存储媒介给注册中心提供服务。
- 引入了Zk作为存储媒介,也就是把Zk的特性引进来,可以进行资源同步,命名服务,以及节点之间的数据和资源进行同步,服务提供者在启动的时候,向 Zk上 的指定节点 /dubbo/serviceName/providers
  目录写入自己的URL地址,这个操作就完成了服务的发布,其他特性还有Mast选举,分布式锁。

### 版本号

- 数据节点都有三种版本信息。
- version ： 数据内容版本号
- cversion: 当前数据子节点的版本号
- aversion: 当前数据节点ACL变更版本号。
- 通过版本号做一个乐观锁的机制,比如不同客户端对某一节点同时发出更新节点的请求，通过版本号的方式来解决并发修改的问题,只能保证一个更新请求执行成功。

### Dubbo和SpringCloud的区别？
- 
