### 评价系统

- 背景：
    - 业务背景：
        - 自如之前的评价体系比较分散,比如各个业务线有自己独立一套的评价体系,就像之前长租体系有自己的一套评价系统,服务业务线（搬家、保洁、维修）也有自己的一套评价体系,
          19年的时候公司就比较注重评价,要将评价进行统一管理,能够将评价数据统一管理,并且统一进行服务者绩效管理,以及低评评价的处理逻辑,以及一些智能化评价推送。同时也 能整体把控评价数据的安全、敏感内容的处理、以及数据分析。
    - 技术背景：
        - 之前评价数据用的是Oracle,当时公司也在整体进行去O工作,而且之前长租的评价系统也就是我负责的这个系统,系统耦合严重,之前被别人重构过,但都没重构完, 导致了3个系统对外提供服务,维护成本很高。

- 项目介绍：
    - 评价系统主要分为3层：
        - 表现层 IOS APP H5 PC后台
        - 业务层 API接口系统 定时任务系统 评价基础服务
        - 数据层 Mysql + Es

    - 概述：评价中台接入了自如所有业务线的评价,通过分配的token区分流量入口,可以根据sentinel对每个业务线进行流量隔离,系统提供一整套评价流程
      创建评价单、获取问题、提交评价、查看评价详情、低分评价工单处理流程、评价列表等。 通过评价场景+模板的概念来控制可以根据城市、产品、分类 来展示对应的评价问题,以及有自己的一套 H5,
      评价页面、评价列表。如果业务线想接入其实就很简单,创建评价单,获取评价H5页面。同时评价系统做了类似于智能化推荐的功能, 能够向 特定管家和服务者定向推送一类问题。

- 评价模板
    - 根据城市、产品等定位到这个模板,然后还可以根据根据被评人的标签选择指定的题目以及随机问题的展示规则等。

- 做了什么？
    - 重构、去O
    - 通用能力开发
    - 业务线对接评价系统
    - 分库分表

### 数据迁移

- 数据库双写, 事务模型以老的为准,查询也走老模型
- 定时任务把历史数据迁移到新表中
- 实时数据：通过定时任务进行新老数据比对,并将数据不同差异补全

- 历史数据同步完毕切实时数据对比没有问题
- 数据源切为新表的数据源
- 依然是双写,事务模型以新模型为准,查询走新模型
- 定时任务接着比对新表老表数据

- 老模型不在同步写入、
- 数据平台迁移为新表数据源 把老表废除

### 非分区key映射

- NoSql
    - 首先我们是通过基础平台提供的Canal,将评价单分表聚合起来形成一个Es,这个Es上包括了uid、phone、bizCode等,当业务线或者评价 自己使用非sharding
      key查询的时候,先查询这个Es,可以查到评价单的状态以及单号,之后在查询评价的信息就可以通过评价单号查询出所有相关的信息.

- DB映射表
    - 基础平台提供的Es存在不稳定的情况,有时候可能消费延迟了,就会存在 根据uid 或者 bizCode在Es上查不到该条评价记录,此时就会影响业务,比如业务端的评价
      列表,就存在有时候管家邀约业主去评价时,业主打开列表却看不到评价单内容,不能评价。找过基础平台谈过这件事,现在好了很多,但是偶尔还会存在这种情况。
    - 为了解决这种情况,以及预防就及时Es服务不可用的情况下,只要DB可用,就不会影响评价系统对外提供服务,就设计了非 sharding key-Mapping的这个表。
    - 当非sharding key 的字段去查询评价信息, 首先通过Es去查,如果查不到,就去Mapping表查询到对应的评价单号,再去查对应的信息。

- 映射表上线流程：先进行实时写

### 业务线历史数据迁移

- 首先我们在评价系统创建好一系列的评价问题和答案 内容对应到业务线的历史评价数据,并告诉业务线这些评价问题和答案编码，约定迁移数据的接口,创建评价单的数据
  以及评价答案的数据一起打包传递过来,通过MQ的方式,评价这面声明一个队列,业务线往里发消息,主要是为了削峰,业务线肯定批量调么,为了不影响评价系统的性能,
  所以用mq的方式慢慢消费,这个过程中,执行失败或者成功都用mongo标记,并且处理完给业务线发送状态消息,告诉这条消息有没有正确 的消费掉。没有正确消费掉的
  消息，最后双方一起排查一下问题,接着消费。（当然在实际迁移过程中,失败的情况很少）

### 评价分布式事务解决方案
https://xiaomi-info.github.io/2020/01/02/distributed-transaction/

- 本地消息表：
   最大努力通知：
   - 评价系统涉及到的分布式事务主要就在于评价状态的流转,某些业务线会记录评价单的单号以及状态,评价系统提供的方案就是用户提交完评价后发送消息
    通知各业务线,这个过程评价系统会记录一个本地消息表,存取评价单号以及评价状态,业务线收到消息后回调确认评价状态的一个接口,评价系统这面将该消息
     表的评价状态变更为已评价。否则就会去轮询尝试发送消息直到重试最大次数。
   - 同时评价系统也暴露查询评价状态的接口,如果业务线需要特别实时的评价状态,可以选择直接调用评价状态的接口。



### 会议平台